# Builds for all architectures and maybe creates a release
name: Build

on: push

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x86
          - arch: x86_64
          - arch: armhf
          - arch: arm64
    steps:
      - name: Install x86 dependencies
        if: ${{ matrix.arch == 'x86' }}
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y uuid-dev:i386 libblkid-dev:i386 libudev-dev:i386 zlib1g-dev:i386

      - name: Install x86_64 dependencies
        if: ${{ matrix.arch == 'x86_64' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y uuid-dev libblkid-dev libudev-dev zlib1g-dev

      - name: Install arm dependencies
        if: ${{ matrix.arch == 'armhf' || matrix.arch == 'arm64' }}
        run: |
          sudo dpkg --add-architecture ${{ matrix.arch }}
          echo 'deb [arch=${{ matrix.arch }}] http://ports.ubuntu.com/ubuntu-ports noble main universe\n' \
            | sudo tee /etc/apt/sources.list.d/ports.list
          sudo apt-get update
          sudo apt-get install -y uuid-dev libblkid-dev libudev-dev zlib1g-dev

          # Download ARM runtime libraries and extract into system paths
          cd /tmp
          apt-get download libuuid1:${{ matrix.arch }} libblkid1:${{ matrix.arch }} libudev1:${{ matrix.arch }} zlib1g:${{ matrix.arch }}
          for deb in *.deb; do sudo dpkg -x "$deb" /; rm "$deb"; done

          # Create unversioned .so symlinks needed by the linker
          if [ "${{ matrix.arch }}" = "armhf" ]; then
            cd /usr/lib/arm-linux-gnueabihf
          else
            cd /usr/lib/arm64-linux-gnu
          fi
          for f in lib*.so.*; do
            lib="${f%%.*}"
            [ ! -e "$lib.so" ] && sudo ln -s "$f" "$lib.so"
          done

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2

      - name: Download btrfs-progs
        run: |
          git clone --depth 1 https://github.com/kdave/btrfs-progs.git
          mkdir -p btrfs-progs/include
          cp btrfs-progs-config.h btrfs-progs/include/config.h

      - name: Build for x86
        if: ${{ matrix.arch == 'x86' }}
        run: |
          zig build -Doptimize=ReleaseSmall -p . \
            -Dtarget=x86-linux-gnu.2.39 \
            -Dsys-lib-dir=/usr/lib/i386-linux-gnu \
            -Dsys-include-dir=/usr/include

      - name: Build for x86_64
        if: ${{ matrix.arch == 'x86_64' }}
        run: |
          zig build -Doptimize=ReleaseSmall -p .

      - name: Build for armhf
        if: ${{ matrix.arch == 'armhf' }}
        run: |
          zig build -Doptimize=ReleaseSmall -p . \
            -Dtarget=arm-linux-gnueabihf.2.39 \
            -Dsys-lib-dir=/usr/lib/arm-linux-gnueabihf \
            -Dsys-include-dir=/usr/include

      - name: Build for arm64
        if: ${{ matrix.arch == 'arm64' }}
        run: |
          zig build -Doptimize=ReleaseSmall -p . \
            -Dtarget=arm64-linux-gnu.2.39 \
            -Dsys-lib-dir=/usr/lib/arm64-linux-gnu \
            -Dsys-include-dir=/usr/include

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: btrfs-hash-${{ matrix.arch }}
          path: btrfs-hash

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4

      - name: Rename binaries
        run: |
          for arch in x86 x86_64 armhf arm64; do
            mv "btrfs-hash-${arch}/btrfs-hash" "btrfs-hash-${arch}"
          done

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: btrfs-hash-*
