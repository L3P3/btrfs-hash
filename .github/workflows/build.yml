name: Build
on: push

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x86
          - arch: x86_64
          - arch: armv7
          - arch: aarch64
    steps:
      - uses: actions/checkout@v4

      - uses: mlugg/setup-zig@v2

      - name: Clone btrfs-progs
        run: |
          git clone --depth 1 https://github.com/kdave/btrfs-progs.git
          mkdir -p btrfs-progs/include
          cp btrfs-progs-config.h btrfs-progs/include/config.h

      - name: Setup QEMU (for container builds)
        uses: docker/setup-qemu-action@v2

      - name: Install native dependencies (x86_64)
        if: ${{ matrix.arch == 'x86_64' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y libbtrfs-dev uuid-dev libblkid-dev libudev-dev zlib1g-dev libssl-dev

      - name: Native build (x86_64)
        if: ${{ matrix.arch == 'x86_64' }}
        run: |
          zig build -Doptimize=ReleaseSmall -p .

      - name: Build in x86 container
        if: ${{ matrix.arch == 'x86' }}
        run: |
          docker run --rm --platform linux/i386 -v $PWD:/work -w /work debian:bookworm bash -lc "set -e; apt-get update; apt-get install -y --no-install-recommends ca-certificates curl xz-utils build-essential pkg-config uuid-dev libblkid-dev libudev-dev zlib1g-dev libssl-dev libbtrfs-dev; curl -L https://ziglang.org/download/0.15.2/zig-linux-x86-0.15.2.tar.xz -o zig.tar.xz; tar -xJf zig.tar.xz; PATH=\$PWD/zig-linux-x86-0.15.2:\$PATH zig build -Doptimize=ReleaseSmall -p ."

      - name: Build in armv7 container
        if: ${{ matrix.arch == 'armv7' }}
        run: |
          docker run --rm --platform linux/arm/v7 -v $PWD:/work -w /work arm32v7/ubuntu:24.04 bash -lc "set -e; apt-get update; apt-get install -y --no-install-recommends ca-certificates curl build-essential pkg-config uuid-dev libblkid-dev libudev-dev zlib1g-dev libssl-dev libbtrfs-dev; curl -L https://ziglang.org/download/0.15.2/zig-linux-armv7-0.15.2.tar.xz -o zig.tar.xz; tar -xJf zig.tar.xz; PATH=\$PWD/zig-linux-armv7-0.15.2:\$PATH zig build -Doptimize=ReleaseSmall -p ."

      - name: Build in aarch64 container
        if: ${{ matrix.arch == 'aarch64' }}
        run: |
          docker run --rm --platform linux/arm64/v8 -v $PWD:/work -w /work arm64v8/ubuntu:24.04 bash -lc "set -e; apt-get update; apt-get install -y --no-install-recommends ca-certificates curl build-essential pkg-config uuid-dev libblkid-dev libudev-dev zlib1g-dev libssl-dev libbtrfs-dev; curl -L https://ziglang.org/download/0.15.2/zig-linux-aarch64-0.15.2.tar.xz -o zig.tar.xz; tar -xJf zig.tar.xz; PATH=\$PWD/zig-linux-aarch64-0.15.2:\$PATH zig build -Doptimize=ReleaseSmall -p ."

      - uses: actions/upload-artifact@v4
        with:
          name: btrfs-hash-${{ matrix.arch }}
          path: btrfs-hash

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4

      - name: Rename binaries
        run: |
          for arch in x86 x86_64 armv7 aarch64; do
            mv "btrfs-hash-${arch}/btrfs-hash" "btrfs-hash-${arch}"
          done

      - uses: softprops/action-gh-release@v2
        with:
          files: btrfs-hash-*
